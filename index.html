<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Inventory App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif !important;
            background-color: #f3f4f6 !important;
            font-size: 1rem !important;
            line-height: 1.5rem !important;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 20rem;
        }
        .task-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0 0 0;
            flex-grow: 1;
        }
        .task-item {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .task-item input[type="text"] {
            background: none;
            border: none;
            outline: none;
            width: 100%;
            padding: 0;
            margin: 0;
        }
        .task-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .add-task-btn {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .add-task-btn:hover {
            background-color: #2563eb;
        }
        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .delete-btn:hover {
            color: #b91c1c;
        }
        .sortable-ghost {
            background-color: #dbeafe !important;
            border: 2px dashed #93c5fd !important;
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <div class="bg-blue-600 text-white py-6">
        <header class="container flex flex-col items-center">
            <div class="bg-blue-800 text-white rounded-xl py-3 px-6 shadow-lg mb-4 text-center">
                <h1 class="text-3xl font-bold">MENTAL INVENTORY</h1>
            </div>
            <p class="text-sm text-blue-200">Drag and drop tasks between lists to organize your thoughts.</p>
            <p id="user-id" class="mt-4 text-xs font-semibold text-blue-300">Loading User ID...</p>
        </header>
    </div>

    <main class="flex-grow flex overflow-x-auto gap-6 py-8 px-4 font-normal text-base !important;">

        <!-- Column 1: What I Want To Do -->
        <div id="want-to-do" class="card shadow-lg">
            <h2 class="text-xl font-semibold text-blue-800 border-b-2 border-blue-200 pb-2 mb-4">WHAT I WANT TO DO</h2>
            <ul class="task-list"></ul>
            <div class="mt-auto pt-4 border-t-2 border-gray-100">
                <div class="flex items-center gap-2">
                    <input type="text" placeholder="Add a new task..." class="flex-grow rounded-md border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                    <button class="add-task-btn">Add</button>
                </div>
            </div>
        </div>

        <!-- Column 2: What I Should Do -->
        <div id="should-do" class="card shadow-lg">
            <h2 class="text-xl font-semibold text-blue-800 border-b-2 border-blue-200 pb-2 mb-4">WHAT I SHOULD DO</h2>
            <ul class="task-list"></ul>
            <div class="mt-auto pt-4 border-t-2 border-gray-100">
                <div class="flex items-center gap-2">
                    <input type="text" placeholder="Add a new task..." class="flex-grow rounded-md border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                    <button class="add-task-btn">Add</button>
                </div>
            </div>
        </div>

        <!-- Column 3: What I Have To Do -->
        <div id="have-to-do" class="card shadow-lg">
            <h2 class="text-xl font-semibold text-blue-800 border-b-2 border-blue-200 pb-2 mb-4">WHAT I HAVE TO DO</h2>
            <ul class="task-list"></ul>
            <div class="mt-auto pt-4 border-t-2 border-gray-100">
                <div class="flex items-center gap-2">
                    <input type="text" placeholder="Add a new task..." class="flex-grow rounded-md border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                    <button class="add-task-btn">Add</button>
                </div>
            </div>
        </div>

        <!-- Column 4: What I Am Currently Doing -->
        <div id="currently-doing" class="card shadow-lg">
            <h2 class="text-xl font-semibold text-blue-800 border-b-2 border-blue-200 pb-2 mb-4">WHAT I AM CURRENTLY DOING</h2>
            <ul class="task-list"></ul>
            <div class="mt-auto pt-4 border-t-2 border-gray-100">
                <div class="flex items-center gap-2">
                    <input type="text" placeholder="Add a new task..." class="flex-grow rounded-md border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                    <button class="add-task-btn">Add</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for confirmation/messages -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <p id="modal-message" class="text-center font-medium text-lg mb-4">Are you sure you want to delete this task?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-confirm" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Yes, Delete</button>
                <button id="modal-cancel" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script>
        // Firebase and app configuration
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Load Firebase libraries from CDN
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        const loadFirebase = async () => {
            await Promise.all([
                loadScript("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"),
                loadScript("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"),
                loadScript("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js")
            ]);

            const { initializeApp } = window.firebase;
            const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.firebase.auth;
            const { getFirestore, doc, onSnapshot, setDoc, deleteDoc, collection, updateDoc } = window.firebase.firestore;

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Function to finalize auth and set up listeners
            const finalizeAuth = (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id').textContent = `Share this ID to collaborate: ${userId}`;
                    console.log("User signed in with UID:", userId);
                } else {
                    userId = crypto.randomUUID();
                    document.getElementById('user-id').textContent = `You are not signed in. User ID: ${userId}`;
                    console.log("User signed in anonymously with UID:", userId);
                }
                isAuthReady = true;
                setupFirestoreListeners();
            };

            const authTimeout = setTimeout(() => {
                if (!isAuthReady) {
                    console.warn("Authentication taking too long, falling back to anonymous user.");
                    finalizeAuth(null);
                }
            }, 3000);

            onAuthStateChanged(auth, (user) => {
                if (!isAuthReady) {
                    clearTimeout(authTimeout);
                    finalizeAuth(user);
                }
            });

            const authPromise = initialAuthToken
                ? signInWithCustomToken(auth, initialAuthToken)
                : signInAnonymously(auth);

            authPromise.catch(error => {
                console.error("Firebase auth error:", error);
                if (!isAuthReady) {
                    clearTimeout(authTimeout);
                    finalizeAuth(null);
                }
            });
        };

        const loadScript = (src) => new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });

        // UI Elements
        const listContainers = {
            'want-to-do': document.getElementById('want-to-do').querySelector('.task-list'),
            'should-do': document.getElementById('should-do').querySelector('.task-list'),
            'have-to-do': document.getElementById('have-to-do').querySelector('.task-list'),
            'currently-doing': document.getElementById('currently-doing').querySelector('.task-list')
        };
        const inputFields = document.querySelectorAll('input[type="text"]');
        const addButtons = document.querySelectorAll('.add-task-btn');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');
        let taskToDelete = null;

        // Firestore Helper Functions
        const getCollectionPath = () => `/artifacts/${appId}/public/data/tasks`;

        const renderTasks = (tasks) => {
            if (!isAuthReady) return;

            const categorizedTasks = {
                'want-to-do': [],
                'should-do': [],
                'have-to-do': [],
                'currently-doing': []
            };

            tasks.forEach(task => {
                if (categorizedTasks[task.listId]) {
                    categorizedTasks[task.listId].push(task);
                }
            });

            for (const listId in categorizedTasks) {
                const taskList = listContainers[listId];
                taskList.innerHTML = '';
                
                const sortedTasks = categorizedTasks[listId].sort((a, b) => {
                    const aTimestamp = a.timestamp ? (a.timestamp.seconds * 1000 + a.timestamp.nanoseconds / 1e6) : 0;
                    const bTimestamp = b.timestamp ? (b.timestamp.seconds * 1000 + b.timestamp.nanoseconds / 1e6) : 0;
                    return aTimestamp - bTimestamp;
                });

                sortedTasks.forEach(task => {
                    const taskEl = document.createElement('li');
                    taskEl.classList.add('task-item');
                    taskEl.setAttribute('data-id', task.id);
                    taskEl.innerHTML = `
                        <input type="text" value="${task.text}" class="flex-grow" />
                        <button class="delete-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    taskList.appendChild(taskEl);
                });
            }
        };

        const setupFirestoreListeners = () => {
            if (!isAuthReady) return;
            const tasksRef = collection(db, getCollectionPath());
            onSnapshot(tasksRef, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks(tasks);
            }, (error) => {
                console.error("Error fetching tasks:", error);
            });
        };
        
        // Event Handlers
        addButtons.forEach(button => {
            button.addEventListener('click', async (e) => {
                if (!isAuthReady) {
                    console.error("Authentication not ready. Please wait.");
                    return;
                }
                const parentDiv = e.target.closest('.card');
                const listId = parentDiv.id;
                const input = parentDiv.querySelector('input[type="text"]');
                const text = input.value.trim();

                if (text) {
                    const { doc, collection, setDoc } = window.firebase.firestore;
                    const newTaskRef = doc(collection(db, getCollectionPath()));
                    await setDoc(newTaskRef, { text: text, listId: listId, timestamp: new Date() });
                    input.value = '';
                }
            });
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.activeElement.closest('.card')) {
                const button = document.activeElement.closest('.card').querySelector('.add-task-btn');
                if (button) button.click();
            }
        });

        // Edit task text on blur
        document.addEventListener('focusout', async (e) => {
            if (!isAuthReady) {
                console.error("Authentication not ready. Please wait.");
                return;
            }
            const input = e.target;
            if (input.tagName === 'INPUT' && input.closest('.task-item')) {
                const taskId = input.closest('.task-item').dataset.id;
                const taskRef = window.firebase.firestore.doc(db, getCollectionPath(), taskId);
                await window.firebase.firestore.updateDoc(taskRef, { text: input.value.trim() });
            }
        });

        // Delete task confirmation modal
        document.addEventListener('click', (e) => {
            if (e.target.closest('.delete-btn')) {
                const taskItem = e.target.closest('.task-item');
                taskToDelete = {
                    id: taskItem.dataset.id
                };
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        });

        modalConfirmBtn.addEventListener('click', async () => {
            if (!isAuthReady || !taskToDelete) {
                console.error("Authentication not ready or no task to delete.");
                return;
            }
            try {
                const taskRef = window.firebase.firestore.doc(db, getCollectionPath(), taskToDelete.id);
                await window.firebase.firestore.deleteDoc(taskRef);
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                taskToDelete = null;
            } catch (error) {
                console.error("Error deleting task:", error);
                modalMessage.textContent = "Error deleting task. Please try again.";
            }
        });

        modalCancelBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            taskToDelete = null;
        });

        // Drag and drop functionality
        const lists = document.querySelectorAll('.task-list');
        lists.forEach(list => {
            new Sortable(list, {
                group: 'tasks',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: async function (evt) {
                    if (!isAuthReady) {
                        console.error("Authentication not ready. Please wait.");
                        return;
                    }
                    const item = evt.item;
                    const taskId = item.dataset.id;
                    const newListId = evt.to.closest('.card').id;
                    
                    const taskRef = window.firebase.firestore.doc(db, getCollectionPath(), taskId);
                    await window.firebase.firestore.updateDoc(taskRef, { listId: newListId, timestamp: new Date() });
                },
            });
        });

        window.onload = loadFirebase;
    </script>
</body>
</html>
